name: ðŸš€ Deploy Laravel to Hostinger (via LFTP)

on:
  push:
    branches:
      - main  # Ganti 'main' jika branch utama Anda 'master'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      
    # 1. Mengambil kode dari repository
    - name: â¬‡ï¸ Check out repository
      uses: actions/checkout@v4

    # 2. Setup PHP
    - name: âš™ï¸ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3' # Sesuaikan dengan versi PHP di Hostinger
        extensions: mbstring, dom, curl, json, pdo, pdo_mysql
        tools: composer
      env:
        COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 3. Instal semua dependency (BUAT FOLDER VENDOR)
    - name: ðŸ“¦ Install Composer Dependencies
      run: composer install --no-dev --no-interaction --optimize-autoloader

    # 4. Buat file .env dari GitHub Secret
    - name: ðŸ“ Create .env file
      run: echo "${{ secrets.ENV_FILE }}" > .env
      
    # 5. Buat Kunci Aplikasi Laravel
    - name: ðŸ”‘ Generate Laravel App Key
      run: php artisan key:generate

    # 6. Optimasi Laravel untuk produksi
    - name: âš¡ Optimize Laravel
      run: |
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        
    # 7. Hapus file yang tidak perlu di-upload
    - name: ðŸ§¹ Clean up files
      run: |
        rm -rf .git
        rm -rf .github
        rm -f .gitignore

    # 8. Deploy menggunakan LFTP (Metode Baru yang Lebih Tangguh)
    - name: â¬†ï¸ Deploy files via LFTP
      # --- PERBAIKAN: Nama action yang benar adalah lftp-action ---
      uses: web-server-deploy/lftp-action@v1.4
      with:
        server: ftp://${{ secrets.FTP_SERVER }}
        user: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        
        # Opsi LFTP:
        # --delete: Menghapus file di server yg tidak ada di repo
        # --mirror: Sinkronisasi (hanya upload yg berubah)
        # --parallel=5: Upload 5 file sekaligus (lebih cepat)
        # --verbose: Tampilkan log lengkap
        # --exclude: File/folder yg tidak perlu di-upload
        lftp-options: >
          -e "set ftp:ssl-allow no;
          set cmd:fail-exit yes;
          set net:timeout 10;
          set net:max-retries 2;
          set net:reconnect-interval-base 5;
          mirror --delete --parallel=5 --verbose
          --exclude .git/ --exclude .github/ --exclude .gitignore
          ."
          
        # 'local-dir' adalah sumber (semua file di runner)
        # 'server-dir' adalah tujuan di Hostinger
        local-dir: "."
        server-dir: "/public_html/"
